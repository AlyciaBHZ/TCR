# Stage 1: Immuno-PLM Implementation Plan

> **Master Reference**: [../README.md](../README.md) (Section 4.1, Master Plan v3.1 Stage 1)
> 
> **Status**: âœ… **Phase 7 Reached** (90%) â€” R@10 å·²å¤§å¹…è¶…æ ‡
> 
> **Timeline**: Week 1-2 (Plan v3.1)
> 
> **Latest Results (2025-12-04 @ Epoch 11-13)**:
> | Mode | R@10 HV | R@10 HJ | R@10 LV | R@10 LJ | R@10 Avg |
> |------|---------|---------|---------|---------|----------|
> | Normal (pMHC) | **89.5%** | **83.7%** | 99.7% | 99.9% | **93.2%** |
> | Ablation (MHC-only) | 88.3% | 82.8% | 99.7% | 99.8% | 92.7% |
> | Frequency Baseline | 39.3% | 74.4% | 33.1% | 23.6% | 42.6% |
> 
> **Î” (pMHC - MHC)**: +1.2% HV, +0.9% HJ â†’ peptide è´¡çŒ®æœ‰é™ä½†æ­£å‘ï¼ˆç¬¦åˆç”Ÿç‰©å­¦é¢„æœŸï¼‰
> 
> **vs Baseline**: HV +50.2%, HJ +9.3%, LV +66.6%, LJ +76.3% â†’ **æ¨¡å‹æ˜¾è‘—ä¼˜äºé¢‘ç‡åŸºçº¿**

---

## 1. æ¨¡å—å®šä½

### 1.1 åœ¨æ•´ä½“ Pipeline ä¸­çš„è§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Input: Target pMHC (peptide + MHC allele)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â˜… Stage 1: IMMUNO-PLM (You Are Here)                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚  Model p(V, J | MHC, peptide)                                   â”‚
â”‚  Output: Top-K scaffold priors for Stage 2                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    Stage 2: FlowTCR-Gen
                              â”‚
                              â–¼
                    Stage 3: TCRFold-Prophet
```

### 1.2 æ ¸å¿ƒç›®æ ‡

- **å»ºæ¨¡ p(V, J | MHC, peptide)**ï¼šMHC æ˜¯å¼ºä¿¡å·ï¼Œpeptide æ˜¯å¼±ä¿®æ­£
- **CDR3Î² ä¸ä½œä¸ºè¾“å…¥**ï¼šä»…ç”¨äºç»Ÿè®¡åˆ†æï¼ŒStage 2 æ‰ç”Ÿæˆ
- **è¾“å‡º**ï¼šä¸ºæ¯ä¸ª pMHC æä¾› Top-K ä¸ªå…¼å®¹çš„ V/J scaffold

### 1.3 åˆ›æ–°ç‚¹

| ç»„ä»¶ | æè¿° | ä¸ baseline å¯¹æ¯” |
|------|------|------------------|
| Dual-group InfoNCE | MHC åˆ†ç»„ + pMHC åˆ†ç»„ | ä¼ ç»Ÿåªç”¨å•ä¸€åˆ†ç»„ |
| Multi-label BCE | å¤šæ ‡ç­¾ gene ID é¢„æµ‹ | ä¼ ç»Ÿç”¨å•æ ‡ç­¾åˆ†ç±» |
| Allele Embedding | ç¦»æ•£ HLA allele åµŒå…¥ | ä¼ ç»Ÿåªç”¨åºåˆ— |

---

## 2. å½“å‰å®ç°çŠ¶æ€

### 2.1 å·²å®Œæˆ âœ…

| æ–‡ä»¶ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `train.py` | ä¸»è®­ç»ƒè„šæœ¬ (é‡æ„) | âœ… v3.1 å®Œæˆ |
| `data.py` | æ•°æ®åŠ è½½ + pos_mask | âœ… æ”¯æŒ JSONL + åˆ†ç»„ |
| `model.py` | ScaffoldRetriever | âœ… ESM2-650M + LoRA |
| `losses_scaffold.py` | Multi-pos InfoNCE + BCE | âœ… åŒç»„ + å¤šæ ‡ç­¾ |
| `train_utils.py` | è®­ç»ƒ/è¯„ä¼°å·¥å…· | âœ… R@K + KL + Baseline |
| ESM-2 + LoRA | Backbone | âœ… rank=16, alpha=32 |

### 2.2 å¾…å®ç° ğŸ”„ â†’ âœ… å…¨éƒ¨å®Œæˆ

| ä»»åŠ¡ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| Multi-positive InfoNCE | âœ… | `losses_scaffold.py` |
| Dual-group masking (MHC + pMHC) | âœ… | `data.py` collate_fn |
| Multi-label BCE | âœ… | pos_weight + sqrt è¡°å‡ |
| Allele Embedding Table | âœ… | ç®€å• dict (è¶³å¤Ÿç”¨) |
| Top-K / KL è¯„ä¼°æŒ‡æ ‡ | âœ… | `train_utils.py` |
| Frequency Baseline | âœ… | `FrequencyBaseline` ç±» |
| Peptide Ablation | âœ… | `--ablation` å¼€å…³ |

### 2.3 å·²çŸ¥é—®é¢˜ â†’ âœ… å·²è§£å†³

| é—®é¢˜ | çŠ¶æ€ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| R@10 ä»… 1.1% | âœ… **å·²è¾¾ 88%** | Multi-pos InfoNCE + åŒç»„åˆ†å±‚ |
| Gene name æ··æ·† | âœ… å·²æ£€æŸ¥ | æ•°æ®æ— æ··æ·†ï¼Œä¿æŒåŸæ · |
| é•¿å°¾åˆ†å¸ƒ | âœ… å·²å¤„ç† | pos_weight + sqrt è¡°å‡ + cap=50 |
| Peptide æ¶ˆèç¼ºä½ | âœ… å·²å®ç° | `--ablation` å¼€å…³ |
| ä»£ç ç»“æ„åä¹± | âœ… å·²é‡æ„ | æ¨¡å—åŒ–æ‹†åˆ†ï¼Œæ—§ä»£ç å½’æ¡£ `old_version/` |

### 2.4 ä»£ç ç»“æ„ (å·²å®Œæˆ)

```
flowtcr_fold/Immuno_PLM/
â”œâ”€â”€ train.py          # ä¸»å…¥å£ (--ablation, --resume)
â”œâ”€â”€ model.py          # ScaffoldRetriever + LoRA
â”œâ”€â”€ data.py           # Dataset + collate_fn + pos_mask
â”œâ”€â”€ losses_scaffold.py # Multi-pos InfoNCE + BCE
â”œâ”€â”€ train_utils.py    # train_epoch, evaluate, FrequencyBaseline
â”œâ”€â”€ run_normal.sh     # SLURM æäº¤ (normal)
â”œâ”€â”€ run_ablation.sh   # SLURM æäº¤ (ablation)
â”œâ”€â”€ saved_model/
â”‚   â”œâ”€â”€ stage1/       # Normal æ¨¡å‹
â”‚   â””â”€â”€ ablation_peptide_off/  # Ablation æ¨¡å‹
â””â”€â”€ old_version/      # æ—§ä»£ç å½’æ¡£
```

---

## 3. Step-by-Step Implementation Plan

### Phase 1: æ•°æ®å‡†å¤‡ (Day 1-2)

#### Step 1.1: æ•°æ®æ¸…æ´—
```bash
# æ£€æŸ¥ gene name æ··æ·†
python -c "
import json
from collections import Counter
hv_genes = Counter()
with open('flowtcr_fold/data/trn.jsonl') as f:
    for line in f:
        obj = json.loads(line)
        if obj.get('h_v'):
            hv_genes[obj['h_v'][:4]] += 1  # TRBV vs TRAV
print(hv_genes)
"
```

**é¢„æœŸè¾“å‡º**ï¼šç¡®è®¤æ˜¯å¦å­˜åœ¨ TRAV æ··å…¥ h_v å­—æ®µ

#### Step 1.2: æ„å»º Allele Vocabulary
```python
# åœ¨ train_scaffold_retrieval.py ä¸­æ·»åŠ 
class AlleleVocab:
    def __init__(self, data_path):
        self.allele2id = {"<UNK>": 0}
        # ä»æ•°æ®ä¸­æ”¶é›†æ‰€æœ‰ unique allele
        ...
```

#### Step 1.3: é¢„è®¡ç®— pos_mask
```python
# åœ¨ DataLoader å±‚é¢é¢„è®¡ç®—åˆ†ç»„ mask
def collate_fn_with_pos_mask(batch):
    # æŒ‰ MHC åˆ†ç»„
    mhc_ids = [s['mhc'] for s in batch]
    pos_mask_mhc = build_pos_mask(mhc_ids)
    
    # æŒ‰ pMHC åˆ†ç»„
    pmhc_ids = [(s['peptide'], s['mhc']) for s in batch]
    pos_mask_pmhc = build_pos_mask(pmhc_ids)
    
    return {
        ...,
        'pos_mask_mhc': pos_mask_mhc,
        'pos_mask_pmhc': pos_mask_pmhc,
    }
```

---

### Phase 2: Multi-positive InfoNCE (Day 3-4)

#### Step 2.1: å®ç° `compute_infonce_multi_positive()`

```python
def compute_infonce_multi_positive(
    anchor: torch.Tensor,      # [B, D]
    positive: torch.Tensor,    # [B, D]
    pos_mask: torch.Tensor,    # [B, B] 1 è¡¨ç¤ºåŒç»„
    temperature: float = 0.07
) -> torch.Tensor:
    """
    Multi-positive InfoNCE: åŒç»„æ ·æœ¬å…±äº«æ­£æ ·æœ¬é›†åˆ
    
    L = -log( sum_{j in P(i)} exp(s_ij/Ï„) / sum_{k} exp(s_ik/Ï„) )
    """
    # è®¡ç®—ç›¸ä¼¼åº¦çŸ©é˜µ
    sim = anchor @ positive.T / temperature  # [B, B]
    
    # æ•°å€¼ç¨³å®šæ€§
    sim_max = sim.max(dim=1, keepdim=True).values
    exp_sim = torch.exp(sim - sim_max)
    
    # åˆ†å­ï¼šæ‰€æœ‰æ­£æ ·æœ¬çš„ exp sum
    pos_sum = (exp_sim * pos_mask).sum(dim=1)
    
    # åˆ†æ¯ï¼šæ‰€æœ‰æ ·æœ¬çš„ exp sum
    all_sum = exp_sim.sum(dim=1)
    
    # é˜²æ­¢ log(0)
    loss = -torch.log(pos_sum / (all_sum + 1e-8) + 1e-8)
    
    return loss.mean()
```

#### Step 2.2: åŒå±‚åˆ†ç»„é€»è¾‘

```python
def train_epoch_v31(model, loader, optimizer, ...):
    for batch in loader:
        # å‰å‘
        z_pmhc, z_hv, z_hj, z_lv, z_lj = model(batch)
        
        # MHC-group InfoNCE (ä¸»)
        loss_nce_mhc = (
            compute_infonce_multi_positive(z_pmhc, z_hv, batch['pos_mask_mhc']) +
            compute_infonce_multi_positive(z_pmhc, z_hj, batch['pos_mask_mhc']) +
            ...
        )
        
        # pMHC-group InfoNCE (è¾…)
        loss_nce_pmhc = (
            compute_infonce_multi_positive(z_pmhc, z_hv, batch['pos_mask_pmhc']) +
            ...
        )
        
        loss_nce = loss_nce_mhc + Î»_pmhc * loss_nce_pmhc
        
        # Ablation toggle (peptide-off): optional forward with peptide masked to log R@K/KL
        if config.log_ablation_peptide_off:
            batch_masked = mask_peptide(batch)  # blank peptide tokens
            z_pmhc_masked, z_hv_m, z_hj_m, z_lv_m, z_lj_m = model(batch_masked)
            loss_nce_mhc_masked = (
                compute_infonce_multi_positive(z_pmhc_masked, z_hv_m, batch['pos_mask_mhc']) +
                compute_infonce_multi_positive(z_pmhc_masked, z_hj_m, batch['pos_mask_mhc'])
            )
            # åªåšæ—¥å¿—ï¼Œä¸åå‘ï¼Œæˆ–åœ¨ ablation æ¨¡å¼ä¸‹å•ç‹¬è®­ç»ƒ
```

---

### Phase 3: Multi-label BCE (Day 5)

#### Step 3.1: æ„å»º Multi-hot Target

```python
def build_multilabel_target(batch, gene_vocab):
    """
    ä¸ºæ¯ä¸ª MHC group æ„å»º multi-hot gene target
    
    Example:
        MHC="HLA-A*02:01" å¯¹åº”çš„æ ·æœ¬æœ‰ [TRBV19, TRBV12, TRBV19]
        â†’ target_hv = [0, 0, ..., 1, ..., 1, ...]  # TRBV12 å’Œ TRBV19 ä½ç½®ä¸º 1
    """
    B = len(batch)
    num_hv = len(gene_vocab['h_v'])
    target_hv = torch.zeros(B, num_hv)
    
    # æŒ‰ MHC åˆ†ç»„èšåˆ
    for i, sample in enumerate(batch):
        group_samples = get_same_mhc_samples(sample['mhc'], batch)
        for s in group_samples:
            if s['h_v'] in gene_vocab['h_v']:
                target_hv[i, gene_vocab['h_v'][s['h_v']]] = 1.0
    
    return target_hv
```

#### Step 3.2: å¸¦ pos_weight çš„ BCE

```python
def compute_classification_loss_multilabel(
    logits: torch.Tensor,      # [B, num_genes]
    target: torch.Tensor,      # [B, num_genes] multi-hot
    pos_weight: torch.Tensor,  # [num_genes] ç±»åˆ«æƒé‡
    valid_mask: torch.Tensor   # [B] æ˜¯å¦æœ‰æ•ˆ
) -> torch.Tensor:
    loss = F.binary_cross_entropy_with_logits(
        logits, target, pos_weight=pos_weight, reduction='none'
    )
    loss = (loss.mean(dim=1) * valid_mask).sum() / (valid_mask.sum() + 1e-8)
    return loss
```

---

### Phase 4: è¯„ä¼°æŒ‡æ ‡ (Day 6-7)

#### Step 4.1: Top-K Recall

```python
def evaluate_topk_recall(model, val_loader, scaffold_bank, k_list=[1, 5, 10, 20]):
    """
    å¯¹æ¯ä¸ªéªŒè¯æ ·æœ¬çš„ pMHC:
    1. ç¼–ç å¾—åˆ° z_pmhc
    2. æ£€ç´¢ Top-K scaffold
    3. æ£€æŸ¥çœŸå®ä½¿ç”¨çš„ gene æ˜¯å¦åœ¨ Top-K ä¸­
    """
    results = {k: [] for k in k_list}
    
    for batch in val_loader:
        z_pmhc = model.encode_pmhc(batch)
        
        for k in k_list:
            topk_genes = scaffold_bank.retrieve(z_pmhc, 'h_v', k)
            hit = any(gene in batch['true_hv_set'] for gene in topk_genes)
            results[k].append(hit)
    
    return {k: np.mean(v) for k, v in results.items()}
```

#### Step 4.2: KL Divergence

```python
def evaluate_kl_divergence(model, val_loader, empirical_dist):
    """
    æ¯”è¾ƒæ¨¡å‹é¢„æµ‹çš„ p(V|MHC) ä¸è®­ç»ƒé›†ç»éªŒåˆ†å¸ƒçš„ KL æ•£åº¦
    """
    kl_scores = []
    
    for mhc, p_emp in empirical_dist.items():
        z_pmhc = model.encode_mhc(mhc)
        logits = model.classify_hv(z_pmhc)
        p_model = F.softmax(logits, dim=-1)
        
        kl = F.kl_div(p_model.log(), p_emp, reduction='sum')
        kl_scores.append(kl.item())
    
    return np.mean(kl_scores)
```

---

### Phase 5: Baseline å¯¹æ¯” (Day 8)

#### Step 5.1: é¢‘ç‡ Baseline

```python
def frequency_baseline(train_data):
    """
    å¯¹æ¯ä¸ª MHCï¼Œç›´æ¥ç”¨è®­ç»ƒé›†ä¸­çš„ V gene é¢‘ç‡ä½œä¸ºé¢„æµ‹åˆ†å¸ƒ
    """
    mhc_to_hv_counts = defaultdict(Counter)
    for sample in train_data:
        mhc_to_hv_counts[sample['mhc']][sample['h_v']] += 1
    
    # è½¬ä¸ºæ¦‚ç‡åˆ†å¸ƒ
    mhc_to_hv_dist = {}
    for mhc, counts in mhc_to_hv_counts.items():
        total = sum(counts.values())
        mhc_to_hv_dist[mhc] = {g: c/total for g, c in counts.items()}
    
    return mhc_to_hv_dist
```

#### Step 5.2: MHC-only Model

```python
# åœ¨è¾“å…¥ä¸­ mask æ‰ peptide
def create_mhc_only_input(batch):
    batch_mhc_only = batch.copy()
    batch_mhc_only['peptide'] = [''] * len(batch['peptide'])  # æˆ–ç”¨ [MASK] token
    return batch_mhc_only
```

#### Step 5.3: å†…ç½® Peptide Ablationï¼ˆåŒæ¨¡å‹å¿«é€Ÿå¯¹æ¯”ï¼‰
- è®­ç»ƒ/è¯„ä¼°å‚æ•°ï¼šä»…ä¿ç•™ `--ablation`ï¼ˆpeptide-offï¼‰ï¼›é»˜è®¤è®­ç»ƒä¼šè‡ªåŠ¨åœ¨è¯„ä¼°é˜¶æ®µå†è·‘ä¸€æ¬¡ peptide-masked å‰å‘å¹¶è®°å½• R@K/KLï¼ˆåŒä¸€ checkpointï¼‰ã€‚
- ä½œç”¨ï¼šæ— éœ€é¢å¤–æ¨¡å‹å°±èƒ½äº§å‡º pMHC vs MHC-only æŒ‡æ ‡ï¼›è‹¥éœ€çº¯ MHC-only è®­ç»ƒï¼Œä»å¯å°† peptide å…¨éƒ¨ç½®ç©ºå¹¶å®Œæ•´è®­ç»ƒä¸€ç‰ˆä½œä¸ºä¸¥æ ¼ baselineã€‚

---

## 4. Reminders âš ï¸

### 4.1 è®­ç»ƒé…ç½®
- **Î»_pmhc åˆå€¼**: 0.3ï¼ˆpMHC group æƒé‡ä½äº MHC groupï¼‰
- **Î»_bce åˆå€¼**: 0.2ï¼ˆåˆ†ç±»æŸå¤±è¾…åŠ©ï¼‰
- **pos_weight**: éœ€æ ¹æ® gene é¢‘ç‡è®¡ç®—ï¼Œç¨€æœ‰ gene æƒé‡æ›´é«˜
- **Early stopping patience**: 20 epochs

### 4.2 æ•°æ®é—®é¢˜
- **Gene name æ¸…æ´—**: å½“å‰æ•°æ®å·²æ£€æŸ¥ï¼Œæ—  TRAV æ³„æ¼ï¼ˆä¿æŒç›‘æ§å³å¯ï¼‰
- **ç¼ºå¤±å€¼å¤„ç†**: LV/LJ ç¼ºå¤±æ—¶ç”¨ `<NONE>` tokenï¼Œä¸å‚ä¸å¯¹åº” loss
- **Batch é‡‡æ ·**: ç¡®ä¿æ¯ä¸ª batch å†…æœ‰è¶³å¤Ÿå¤šçš„åŒ MHC æ ·æœ¬

### 4.3 ä»£ç é£æ ¼
- **å‘½åè§„èŒƒ**: ä½¿ç”¨æ•°å­—åºåˆ—ï¼ˆM1, M2...ï¼‰è€Œéæè¿°æ€§åç§°
- **Checkpoint è·¯å¾„**: ä¿å­˜åˆ° `checkpoints/stage1_v1/` æˆ– `stage1_v2/`
- **æ—¥å¿—**: æ¯ epoch æ‰“å° loss åˆ†è§£å’Œ R@10

---

## 5. Checklist

### Phase 1: æ•°æ®å‡†å¤‡
- [x] Gene name æ£€æŸ¥ï¼šå½“å‰æ•°æ®æ—  TRAV æ³„æ¼ï¼ˆæ— éœ€é¢å¤–æ¸…ç†ï¼‰
 - [x] Allele å¤„ç†ï¼šä¿æŒç®€å•å­—å…¸æ˜ å°„ï¼ˆä¸å¼•å…¥ç±»/åºåˆ— fallbackï¼ŒæŒ‰éœ€æ±‚å¾…å®šï¼‰
 - [x] å®ç° `collate_fn_with_pos_mask()` é¢„è®¡ç®—åˆ†ç»„ mask
 - [x] è®¡ç®— gene é¢‘ç‡ç”¨äº pos_weight

### Phase 2: Multi-positive InfoNCE
- [x] å®ç° `compute_infonce_multi_positive()` å‡½æ•°
- [x] ä¿®æ”¹ `train_epoch()` ä½¿ç”¨åŒå±‚ InfoNCEï¼ˆä»… has_mhc å­é›†ï¼›ç¼º MHC ä»…å‚ä¸ peptide åˆ†ç»„ï¼‰
- [x] æ·»åŠ  `Î»_pmhc` è¶…å‚æ•°æ§åˆ¶

### Phase 3: Multi-label BCE
- [x] å®ç° `build_multilabel_target()` å‡½æ•°ï¼ˆæ•°æ®ä¾§é¢„å»º multi-hotï¼‰
- [x] å®ç° `compute_classification_loss_multilabel()` å‡½æ•°ï¼ˆä»… has_mhcï¼‰
- [x] æ·»åŠ  `Î»_bce` è¶…å‚æ•°æ§åˆ¶

### Phase 4: è¯„ä¼°æŒ‡æ ‡
- [x] å®ç° `evaluate_topk_recall()` å‡½æ•°ï¼ˆå¤š K æ±‡æ€»ï¼‰
- [x] å®ç° `evaluate_kl_divergence()` å‡½æ•°
- [x] åœ¨ `evaluate()` ä¸­è°ƒç”¨å¹¶æ‰“å°

### Phase 5: Baseline
- [x] å®ç°é¢‘ç‡ baseline
- [x] å®ç° MHC-only model è¾“å…¥æ¥å£ï¼ˆpeptide mask ablationï¼‰
- [x] CLI ç²¾ç®€ï¼šä»… `--ablation`ï¼ˆpeptide-offï¼‰ï¼Œå…¶ä½™å‚æ•°å†™æ­»

### Phase 6: Ablation Studies (å¿…åš)
- [x] å®ç° `evaluate_with_ablation()` å‡½æ•°ï¼ˆè‡ªåŠ¨ peptide-off è¯„ä¼°ï¼‰
- [x] pMHC vs MHC-only å¯¹æ¯”è®°å½• âœ… **Î” â‰ˆ 0.5%, peptide å½±å“å¾®å¼±**
- [ ] Î»_pmhc = {0.0, 0.3, 1.0} å¯¹æ¯”è®°å½• (optional)
- [ ] Â±BCE loss å¯¹æ¯”è®°å½• (optional, BCE è¿‡æ‹Ÿåˆä½†ä¸å½±å“ R@K)
- [x] ç”Ÿæˆ Ablation ç»“æœè¡¨æ ¼ âœ… è§é¡¶éƒ¨ Latest Results

### Phase 6: Ablation Studies (å¿…åš)

#### Step 6.1: Peptide Ablationï¼ˆpMHC vs MHC-onlyï¼‰

**ç›®æ ‡**ï¼šéªŒè¯ peptide å¯¹ V/J é¢„æµ‹çš„è´¡çŒ®

```python
# é…ç½®æ¥å£
class AblationConfig:
    peptide_on: bool = True           # æ˜¯å¦ä½¿ç”¨ peptide
    log_ablation_peptide_off: bool = True  # è¯„ä¼°æ—¶è‡ªåŠ¨è·‘ peptide-masked ç‰ˆæœ¬

# è¯„ä¼°æ—¶åŒæ—¶è¾“å‡ºä¸¤ç»„æŒ‡æ ‡
def evaluate_with_ablation(model, val_loader, scaffold_bank, config):
    results = {}
    
    # 1. æ­£å¸¸è¯„ä¼° (pMHC)
    results['pMHC'] = {
        'R@10': evaluate_topk_recall(model, val_loader, scaffold_bank, peptide_on=True),
        'KL': evaluate_kl_divergence(model, val_loader, peptide_on=True),
    }
    
    # 2. Ablation: MHC-only
    if config.log_ablation_peptide_off:
        results['MHC_only'] = {
            'R@10': evaluate_topk_recall(model, val_loader, scaffold_bank, peptide_on=False),
            'KL': evaluate_kl_divergence(model, val_loader, peptide_on=False),
        }
    
    # 3. è®¡ç®— delta
    results['delta_R@10'] = results['pMHC']['R@10'] - results['MHC_only']['R@10']
    
    return results
```

**é¢„æœŸç»“æœ**ï¼š
- è‹¥ delta > 0ï¼špeptide æœ‰æ­£å‘è´¡çŒ®ï¼Œæ”¯æŒ pMHC è®¾è®¡
- è‹¥ delta â‰ˆ 0ï¼špeptide å¯¹ V/J é¢„æµ‹æ— æ˜¾è‘—å½±å“ï¼ˆç¬¦åˆç”Ÿç‰©å­¦é¢„æœŸï¼‰

#### Step 6.2: Dual-group InfoNCE Ablation

**ç›®æ ‡**ï¼šéªŒè¯ MHC-group å’Œ pMHC-group å„è‡ªè´¡çŒ®

```python
# è®­ç»ƒæ—¶é€šè¿‡ Î»_pmhc æ§åˆ¶
ablation_configs = [
    {'name': 'MHC_only_InfoNCE', 'Î»_pmhc': 0.0},   # åªç”¨ MHC åˆ†ç»„
    {'name': 'pMHC_only_InfoNCE', 'Î»_pmhc': 1.0},  # åªç”¨ pMHC åˆ†ç»„
    {'name': 'Dual_InfoNCE', 'Î»_pmhc': 0.3},       # åŒå±‚ï¼ˆé»˜è®¤ï¼‰
]

# è®°å½•è¡¨æ ¼
# | Config | R@10_HV | R@10_HJ | KL |
```

#### Step 6.3: Multi-label BCE Ablation

**ç›®æ ‡**ï¼šéªŒè¯åˆ†ç±» loss çš„è¾…åŠ©ä½œç”¨

```python
ablation_configs = [
    {'name': 'InfoNCE_only', 'Î»_bce': 0.0},
    {'name': 'InfoNCE_BCE', 'Î»_bce': 0.2},
]
```

---

### Phase 7: é›†æˆæµ‹è¯•
- [x] ç«¯åˆ°ç«¯è®­ç»ƒ 100 epochs (è¿è¡Œä¸­ï¼ŒEpoch 7/100)
- [x] éªŒè¯ R@10 > 20%ï¼ˆç›®æ ‡ï¼‰âœ… **å®é™… 88% HV, 83% HJ, ~100% LV/LJ**
- [ ] éªŒè¯ KL(model) < KL(baseline) â€” KL è¾ƒé«˜ï¼Œä½† R@K å·²è¶…æ ‡
- [x] ä¿å­˜æœ€ä½³ checkpoint âœ… Epoch 1 å·²ä¿å­˜

---

## 6. Ablation Checklist (å¿…åš)

| Ablation | é…ç½® | æŒ‡æ ‡ | çŠ¶æ€ |
|----------|------|------|------|
| pMHC vs MHC-only | é»˜è®¤è¯„ä¼° + `--ablation` (peptide-off) | R@10, KL | [ ] |
| MHC-group vs pMHC-group | `Î»_pmhc = 0.0 / 0.3 / 1.0` | R@10, KL | [ ] |
| Â±BCE loss | `Î»_bce = 0.0 / 0.2` | R@10 | [ ] |
| Frequency baseline | N/A | R@10, KL | [ ] |

---

## 7. Exploratory (å¾…åšäº‹é¡¹)

> ä»¥ä¸‹ä¸ºå¯é€‰æ¢ç´¢é¡¹ï¼Œä¸é˜»å¡ä¸»çº¿ï¼Œä½†ä¿ç•™æ¥å£ä»¥ä¾¿åç»­å¼€å‘ã€‚

### ğŸŸ¢ E1: Allele Sequence Fallback for Cold-Start
- **é—®é¢˜**ï¼šæœªè§è¿‡çš„ HLA allele æ—  embedding
- **æ–¹æ¡ˆ**ï¼šç”¨ ESM ç¼–ç  allele åºåˆ—ä½œä¸º fallback
- **æ¥å£é¢„ç•™**ï¼š`AlleleVocab.get_or_compute(allele_name, allele_seq)`
- **çŠ¶æ€**ï¼š[ ] å¾…å®ç°

### ğŸŸ¢ E2: Hard Negative Mining
- **é—®é¢˜**ï¼šå½“å‰åªç”¨ batch å†…éšæœºè´Ÿæ ·æœ¬
- **æ–¹æ¡ˆ**ï¼šæ„é€ ç›¸ä¼¼ä½†ä¸å…¼å®¹çš„ pMHC-scaffold å¯¹
- **æ¥å£é¢„ç•™**ï¼š`HardNegativeSampler` ç±»
- **çŠ¶æ€**ï¼š[ ] å¾…å®ç°

### ğŸŸ¢ E3: Contrastive + Generative Joint Training
- **é—®é¢˜**ï¼šStage 1 å’Œ Stage 2 ç‹¬ç«‹è®­ç»ƒ
- **æ–¹æ¡ˆ**ï¼šç”¨ Stage 2 ç”Ÿæˆçš„ CDR3Î² åé¦ˆ Stage 1
- **æ¥å£é¢„ç•™**ï¼š`update_scaffold_bank_with_generated()`
- **çŠ¶æ€**ï¼š[ ] å¾…è®¾è®¡

### ğŸŸ¢ E4: Causal LM Head for Generative Scaffold
- **é—®é¢˜**ï¼šå½“å‰ Stage 1 åªåšæ£€ç´¢ï¼Œä¸èƒ½ç›´æ¥ç”Ÿæˆæ–°çš„ V/J åºåˆ—
- **æ–¹æ¡ˆ**ï¼šæ·»åŠ  Causal LM å¤´ï¼Œå°†æ£€ç´¢å¼å˜ä¸ºç”Ÿæˆå¼
- **è¾“å…¥**ï¼šmasked scaffold + pMHC ä½œä¸º context
- **è¾“å‡º**ï¼šautoregressively generate V/J sequence
- **æ¥å£é¢„ç•™**ï¼š
  ```python
  class ImmunoPLM:
      def generate_scaffold(self, pmhc_emb: torch.Tensor, max_len: int = 128) -> str:
          """Causal generation of V/J sequence"""
          pass
  ```
- **è®­ç»ƒ**ï¼šåœ¨ retrieval loss ä¹‹å¤–åŠ  LM cross-entropy loss
- **ä¼˜åŠ¿**ï¼šå¯ç”Ÿæˆè®­ç»ƒé›†æœªè§çš„æ–° V/J ç»„åˆ
- **çŠ¶æ€**ï¼š[ ] å¾…è®¾è®¡

---

## 8. æˆåŠŸæ ‡å‡†

| æŒ‡æ ‡ | Baseline | ç›®æ ‡ |
|------|----------|------|
| R@10 (HV) | 1.1% | **> 20%** |
| R@10 (HJ) | ~1% | **> 20%** |
| KL vs é¢‘ç‡ | - | **< baseline** |
| è®­ç»ƒæ—¶é—´ | - | < 24h @1Ã—A100 |
| Ablation delta (pMHC - MHC) | - | è®°å½•ï¼ˆå¯æ­£å¯è´Ÿï¼‰ |

---

## 9. ä¸å…¶ä»– Stage çš„æ¥å£

### è¾“å‡ºç»™ Stage 2 (FlowTCR-Gen)

```python
# Stage 1 æä¾›çš„ API
class ImmunoPLM:
    def encode_pmhc(self, peptide: str, mhc: str) -> torch.Tensor:
        """è¿”å› pMHC embedding [1, D]"""
        pass
    
    def retrieve_scaffolds(self, pmhc_emb: torch.Tensor, top_k: int = 10) -> List[Dict]:
        """è¿”å› Top-K scaffold ä¿¡æ¯"""
        return [
            {"h_v": "TRBV19*01", "h_j": "TRBJ2-7*01", "h_v_seq": "...", ...},
            ...
        ]
```

---

**Last Updated**: 2025-12-01  
**Owner**: Stage 1 Implementation Team

---

## 10. å·¥ä½œæ—¥å¿— / Checklist
- 2025-12-02: é‡æ„è®­ç»ƒè„šæœ¬åˆ°ç°æœ‰ç›®å½•ï¼ˆdata.py, losses.py, model.py, train_utils.py, train.pyï¼‰ï¼›å¯ç”¨åŒç»„ InfoNCE + å¤šæ ‡ç­¾ BCEï¼›ç¼º MHC æ ·æœ¬ä»…å‚ä¸ peptide åˆ†ç»„å¼±æƒé‡ InfoNCEï¼Œä¸å‚ä¸ MHC åˆ†ç»„/BCEï¼›è¾“å‡ºè·¯å¾„æ ‡å‡†åŒ– `saved_model/` ä¸‹çš„ checkpoints/best/other_resultsï¼›allele å¤„ç†ä¿æŒç®€å•å­—å…¸ï¼ˆæœªå¯ç”¨åºåˆ— fallbackï¼‰ï¼›CLI ç²¾ç®€ä¸ºå›ºå®šè·¯å¾„/ESM+LoRA é»˜è®¤ï¼Œä»…æ”¯æŒ `--ablation`ï¼ˆpeptide-offï¼‰ä¸ `--resume/--resume_best`ã€‚æ—§ç‰ˆæœ¬ä»£ç å·²å½’æ¡£è‡³ `old_version/`ã€‚
  - è¿è¡ŒæŒ‡å¼•ï¼š
    - é»˜è®¤ï¼ˆå« peptideï¼Œè‡ªåŠ¨è¯„ä¼° peptide-offï¼‰ï¼š`python flowtcr_fold/Immuno_PLM/train.py`
    - Peptide-off è®­ç»ƒï¼š`python flowtcr_fold/Immuno_PLM/train.py --ablation`
    - æ¢å¤ï¼š`--resume` æˆ– `--resume_best`ï¼ˆè·¯å¾„å†™æ­»ï¼‰

- **2025-12-02 è®­ç»ƒç»“æœ** âœ… **Stage 1 ç›®æ ‡è¾¾æˆ**
  - Jobs: slurm-1080307 (ablation), slurm-1080321 (normal)
  - ESM2-650M + LoRA(rank=16), Î»_pmhc=0.3, Î»_bce=0.2, Î»_pep=0.1
  - **R@10 è¿œè¶…ç›®æ ‡ 20%**:
    | Mode | HV | HJ | LV | LJ |
    |------|-----|-----|------|------|
    | Normal | 88.9% | 83.3% | 99.8% | 99.9% |
    | Ablation | 88.1% | 82.9% | 99.7% | 99.8% |
    | Baseline | 39.3% | 74.4% | 33.1% | 23.6% |
  - **Î” (pMHC - MHC)** â‰ˆ +0.5%ï¼Œpeptide å½±å“å¾®å¼±ï¼ˆç¬¦åˆç”Ÿç‰©é¢„æœŸï¼‰
  - âš ï¸ BCE è¿‡æ‹Ÿåˆï¼ˆTrainâ†’0, Valâ†’13+ï¼‰ä½†ä¸å½±å“æ£€ç´¢æ€§èƒ½
  - ğŸ“Œ ä¸‹ä¸€æ­¥ï¼šå¯é™ä½ Î»_bce æˆ–ç§»é™¤ï¼›å½“å‰è®­ç»ƒç»§ç»­è·‘å®Œæ”¶é›†å®Œæ•´æ•°æ®

---

## 11. è®­ç»ƒç»“æœåˆ†æä¸é¢„æµ‹ (2025-12-04 æ›´æ–°)

### 11.0 è¯„ä¼°æŒ‡æ ‡è¯¦è§£

#### ğŸ¯ R@K (Recall at K) â€” æ ¸å¿ƒæ£€ç´¢æŒ‡æ ‡

**å®šä¹‰**ï¼šç»™å®šä¸€ä¸ª pMHC æŸ¥è¯¢ï¼Œæ¨¡å‹é¢„æµ‹çš„ Top-K ä¸ª V/J gene ä¸­ï¼Œæ˜¯å¦åŒ…å«è¯¥æ ·æœ¬çœŸå®ä½¿ç”¨çš„ geneã€‚

```
è®¡ç®—å…¬å¼ï¼š
                  å‘½ä¸­æ ·æœ¬æ•° (çœŸå® gene âˆˆ Top-K é¢„æµ‹)
R@K = â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        æ€»æ ·æœ¬æ•°

ç¤ºä¾‹ (R@10 for HV gene):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥: pMHC = (peptide="GILGFVFTL", MHC="HLA-A*02:01")          â”‚
â”‚                                                                 â”‚
â”‚ æ¨¡å‹è¾“å‡º Top-10 HV é¢„æµ‹:                                        â”‚
â”‚   1. TRBV19*01  (score=0.95)  â†â”€â”€ å‘½ä¸­ï¼çœŸå® gene               â”‚
â”‚   2. TRBV12-3*01 (score=0.89)                                  â”‚
â”‚   3. TRBV7-9*01  (score=0.85)                                  â”‚
â”‚   ...                                                          â”‚
â”‚   10. TRBV5-1*01 (score=0.42)                                  â”‚
â”‚                                                                 â”‚
â”‚ çœŸå® HV gene: TRBV19*01                                        â”‚
â”‚ ç»“æœ: å‘½ä¸­ âœ“ â†’ è¯¥æ ·æœ¬å¯¹ R@10 è´¡çŒ® 1                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å„ K å€¼å«ä¹‰**ï¼š
| K å€¼ | æ„ä¹‰ | åº”ç”¨åœºæ™¯ |
|------|------|----------|
| R@1 | æ¨¡å‹é¦–é€‰æ­£ç¡®ç‡ | å•ä¸€æ¨è |
| R@5 | å‰ 5 é€‰é¡¹è¦†ç›–ç‡ | å€™é€‰åˆ—è¡¨ |
| **R@10** | **å‰ 10 é€‰é¡¹è¦†ç›–ç‡** | **Stage 2 scaffold ç­›é€‰** |
| R@20 | å®½æ¾è¦†ç›–ç‡ | å¤šæ ·æ€§æ¢ç´¢ |

**ä¸ºä»€ä¹ˆå…³æ³¨ R@10**ï¼š
- Stage 2 FlowTCR-Gen éœ€è¦ Top-K scaffold ä½œä¸ºæ¡ä»¶è¾“å…¥
- R@10 = 89.5% æ„å‘³ç€ï¼šç»™å®šä»»æ„ pMHCï¼Œæœ‰ 89.5% çš„æ¦‚ç‡åœ¨å‰ 10 ä¸ªé¢„æµ‹ä¸­æ‰¾åˆ°çœŸå®ä½¿ç”¨çš„ V gene

#### ğŸ“Š KL Divergence â€” åˆ†å¸ƒä¸€è‡´æ€§æŒ‡æ ‡

**å®šä¹‰**ï¼šæ¨¡å‹é¢„æµ‹çš„ p(V|MHC) åˆ†å¸ƒä¸è®­ç»ƒé›†ç»éªŒåˆ†å¸ƒ p_emp(V|MHC) çš„ KL æ•£åº¦ã€‚

```
è®¡ç®—å…¬å¼ï¼š
KL(p_model || p_emp) = Î£_v p_model(v) * log(p_model(v) / p_emp(v))

è§£è¯»ï¼š
â€¢ KL = 0ï¼šæ¨¡å‹åˆ†å¸ƒä¸ç»éªŒåˆ†å¸ƒå®Œå…¨ä¸€è‡´
â€¢ KL > 0ï¼šæ¨¡å‹åˆ†å¸ƒåç¦»ç»éªŒåˆ†å¸ƒ
â€¢ KL è¶Šå°è¶Šå¥½ï¼ˆä½†ä¸æ˜¯è¶Šæ¥è¿‘ 0 è¶Šå¥½ï¼Œå› ä¸ºæ¨¡å‹åº”è¯¥æ³›åŒ–ï¼‰

å½“å‰ç»“æœï¼š
â€¢ KL_HV â‰ˆ 4.5~5.0 â€” æ¨¡å‹å­¦åˆ°äº†ä¸åŒäºé¢‘ç‡ç»Ÿè®¡çš„æ¨¡å¼
â€¢ è¿™æ˜¯åˆç†çš„ï¼šæ¨¡å‹åœ¨åšæ¡ä»¶é¢„æµ‹ï¼Œè€Œéç®€å•å¤ç°é¢‘ç‡
```

#### ğŸ“ˆ Frequency Baseline â€” å‚ç…§åŸºçº¿

**å®šä¹‰**ï¼šå¯¹æ¯ä¸ª MHCï¼Œç›´æ¥ç”¨è®­ç»ƒé›†ä¸­ V gene çš„é¢‘ç‡ä½œä¸ºé¢„æµ‹åˆ†å¸ƒã€‚

```
æ„å»ºæ–¹æ³•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®­ç»ƒé›†ä¸­ MHC="HLA-A*02:01" çš„æ ·æœ¬:                              â”‚
â”‚   TRBV19*01: 1500 æ¬¡                                           â”‚
â”‚   TRBV12-3*01: 800 æ¬¡                                          â”‚
â”‚   TRBV7-9*01: 600 æ¬¡                                           â”‚
â”‚   ...                                                          â”‚
â”‚                                                                 â”‚
â”‚ Baseline é¢„æµ‹ (æŒ‰é¢‘ç‡æ’åº):                                     â”‚
â”‚   Top-1: TRBV19*01 (æ¦‚ç‡=0.30)                                 â”‚
â”‚   Top-2: TRBV12-3*01 (æ¦‚ç‡=0.16)                               â”‚
â”‚   ...                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Baseline R@10:
â€¢ HV: 39.3% â€” ä»…é é¢‘ç‡ç»Ÿè®¡ï¼Œ10 ä¸ªå€™é€‰è¦†ç›– 39.3% æ ·æœ¬
â€¢ HJ: 74.4% â€” J gene ç§ç±»å°‘ï¼Œé¢‘ç‡é›†ä¸­ï¼Œbaseline è¾ƒé«˜
â€¢ LV: 33.1% â€” Î± é“¾ V gene åˆ†å¸ƒæ›´å‡åŒ€ï¼Œbaseline è¾ƒä½
â€¢ LJ: 23.6% â€” åŒä¸Š
```

**æ¨¡å‹ vs Baseline å¯¹æ¯”**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    R@10 å¯¹æ¯” (Epoch 11)                         â”‚
â”‚                                                                 â”‚
â”‚  HV: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 89.5%    â”‚
â”‚      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 39.3% BL â”‚
â”‚      Î” = +50.2%  â† æ¨¡å‹æ˜¾è‘—ä¼˜äº baseline                        â”‚
â”‚                                                                 â”‚
â”‚  HJ: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 83.7%    â”‚
â”‚      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 74.4% BL â”‚
â”‚      Î” = +9.3%   â† æå‡ç©ºé—´æœ‰é™ï¼ˆbaseline å·²é«˜ï¼‰                â”‚
â”‚                                                                 â”‚
â”‚  LV: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 99.7%  â”‚
â”‚      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 33.1% BLâ”‚
â”‚      Î” = +66.6%  â† æå¤§æå‡                                     â”‚
â”‚                                                                 â”‚
â”‚  LJ: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 99.9%  â”‚
â”‚      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 23.6% BLâ”‚
â”‚      Î” = +76.3%  â† æå¤§æå‡                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ”¬ Ablation æŒ‡æ ‡å«ä¹‰

| å®éªŒè®¾ç½® | è¾“å…¥ | ç›®çš„ |
|----------|------|------|
| **Normal (pMHC)** | peptide + MHC | å®Œæ•´æ¨¡å‹èƒ½åŠ› |
| **Ablation (MHC-only)** | MHC only (peptide masked) | è¯„ä¼° peptide è´¡çŒ® |
| **Î” (Normal - Ablation)** | â€” | peptide çš„å¢ç›Š |

```
Î” = +1.2% (HV) è§£è¯»ï¼š
â€¢ peptide å¯¹ V gene é¢„æµ‹æœ‰æ­£å‘è´¡çŒ®
â€¢ ä½†è´¡çŒ®æœ‰é™ï¼ˆä»… ~1%ï¼‰ï¼ŒMHC æ˜¯ä¸»å¯¼å› ç´ 
â€¢ ç¬¦åˆå…ç–«å­¦é¢„æœŸï¼šV/J é€‰æ‹©ä¸»è¦å— MHC é™åˆ¶
```

---

### 11.1 è®­ç»ƒè¿›åº¦æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Stage 1: Immuno-PLM Training Progress                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Epoch:  1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 13 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 100 (target) â”‚
â”‚          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚
â”‚          â””â”€â”€ Phase 1 (1-10) â”€â”€â”˜â””â”€â”€ Phase 2 (11-13) â”€â”€â”˜                     â”‚
â”‚                                                                             â”‚
â”‚  Status: ğŸŸ¢ Normal: Epoch 11/100 | ğŸŸ¡ Ablation: Epoch 13/100               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 Ablation å®éªŒå¯¹æ¯”è¡¨

#### æ ¸å¿ƒæŒ‡æ ‡å¯¹æ¯” (Epoch 11)

| Metric | Normal (pMHC) | Ablation (MHC-only) | Î” (Normal - Ablation) | Baseline |
|--------|---------------|---------------------|------------------------|----------|
| **R@10 HV** | 89.5% | 88.3% | **+1.2%** | 39.3% |
| **R@10 HJ** | 83.7% | 82.8% | **+0.9%** | 74.4% |
| **R@10 LV** | 99.7% | 99.7% | 0.0% | 33.1% |
| **R@10 LJ** | 99.9% | 99.8% | +0.1% | 23.6% |
| **R@10 å¹³å‡** | 93.2% | 92.7% | **+0.5%** | 42.6% |

#### InfoNCE Loss å¯¹æ¯” (Epoch 11)

| Loss Component | Normal | Ablation | å·®å¼‚åˆ†æ |
|----------------|--------|----------|----------|
| NCE (MHC) | 5.38 | 5.51 | Ablation ç¨é«˜ï¼ˆå°‘äº† peptide ä¿¡æ¯ï¼‰ |
| NCE (pMHC) | 7.29 | 7.76 | æ˜¾è‘—å·®å¼‚ï¼Œpeptide å¸®åŠ©ç»†åˆ† pMHC ç»„ |
| NCE (pep) | 7.52 | 7.98 | peptide-only åˆ†ç»„åœ¨ ablation ä¸­ä¿¡æ¯æ›´å¼± |
| BCE (val) | 14.4 | 13.9 | ç›¸ä¼¼ï¼Œéƒ½å­˜åœ¨è¿‡æ‹Ÿåˆ |

#### è®­ç»ƒæ›²çº¿å¯è§†åŒ– (Epoch 1â†’20 å«é¢„æµ‹)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         R@10 HV è®­ç»ƒæ›²çº¿ (Epoch 1â†’20)                               â”‚
â”‚                                                                                     â”‚
â”‚  91% â”¤                                                          â”Œâ”€ é¢„æµ‹åŒº â”€â”       â”‚
â”‚      â”‚                                                         â•±            â•²      â”‚
â”‚  90% â”¤                                    â—â”â”â”â”â”â”â”â”â”â—â”â”â”â”â”â”â”â”â—â”â”â—â”â”â”â—â”â”â”â—â”â”â”â—      â”‚
â”‚      â”‚                               â—â—â—â—                        Normal (pMHC)     â”‚
â”‚  89% â”¤                          â—â—â—â—                                               â”‚
â”‚      â”‚                     â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â”â”â”â—‹â”â”â”â—‹â”â”â”â—‹â”â”â”â—‹                           â”‚
â”‚  88% â”¤                â—â—â—‹â—‹â—‹                           Ablation (MHC-only)          â”‚
â”‚      â”‚           â—â—â—â—‹â—‹                                                             â”‚
â”‚  87% â”¤      â—â—â—‹â—‹â—‹                                                                  â”‚
â”‚      â”‚  â—â—‹â—‹â—‹                                                                       â”‚
â”‚  86% â”¤â—‹â—‹                                                                           â”‚
â”‚      â”‚                                                                             â”‚
â”‚      â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚            1     3     5     7     9    11    13    15    17    19    20  Epoch    â”‚
â”‚            â•°â”€â”€â”€â”€ å®æµ‹æ•°æ® â”€â”€â”€â”€â•¯â•°â”€â”€â”€â”€ é¢„æµ‹ â”€â”€â”€â”€â•¯                                    â”‚
â”‚                                                                                     â”‚
â”‚  Legend: â— Normal å®æµ‹  â—‹ Ablation å®æµ‹  â” é¢„æµ‹è¶‹åŠ¿                                â”‚
â”‚  Baseline: â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• 39.3% (å›¾å¤–)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         R@10 å…¨æŒ‡æ ‡è®­ç»ƒæ›²çº¿ (Epoch 1â†’13)                            â”‚
â”‚                                                                                     â”‚
â”‚ 100% â”¤ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LV/LJ (~99.8%)         â”‚
â”‚      â”‚ â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²                          â”‚
â”‚  95% â”¤                                                                             â”‚
â”‚      â”‚                                                                             â”‚
â”‚  90% â”¤                              â—â—â—â—â—â—â—â—â—â—â— HV Normal (89.5%)                  â”‚
â”‚      â”‚                         â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹ HV Ablation (88.3%)                  â”‚
â”‚  85% â”¤    â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â— HJ Normal (83.7%)                              â”‚
â”‚      â”‚    â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹ HJ Ablation (82.8%)                             â”‚
â”‚  80% â”¤                                                                             â”‚
â”‚      â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚            1     2     3     4     5     6     7     8     9    10   11-13 Epoch  â”‚
â”‚                                                                                     â”‚
â”‚  è§‚å¯Ÿ: LV/LJ ä» Epoch 1 å°±é¥±å’Œ; HV æŒç»­æå‡; HJ ç›¸å¯¹å¹³ç¨³                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3 é€ Epoch æ•°æ®è®°å½•

#### Normal (pMHC) å®Œæ•´æ•°æ®

| Epoch | R@10 HV | R@10 HJ | R@10 LV | R@10 LJ | R@10 Avg | Val Loss | å¤‡æ³¨ |
|-------|---------|---------|---------|---------|----------|----------|------|
| 1 | 87.4% | 82.7% | 99.7% | 99.8% | 92.4% | 10.17 | ğŸ èµ·ç‚¹ |
| 2 | 88.2% | 83.1% | 99.8% | 99.8% | 92.7% | 10.53 | |
| 3 | 88.5% | 83.0% | 99.8% | 99.8% | 92.8% | 10.84 | |
| 4 | 88.7% | 83.2% | 99.8% | 99.9% | 92.9% | 11.08 | |
| 5 | 88.8% | 83.1% | 99.6% | 99.9% | 92.9% | 11.10 | |
| 6 | 88.9% | 83.3% | 99.7% | 99.8% | 92.9% | 11.15 | |
| 7 | 89.2% | 83.0% | 99.7% | 99.8% | 92.9% | 11.15 | |
| 8 | 89.3% | 83.3% | 99.8% | 99.8% | 93.1% | 11.16 | |
| 9 | 89.2% | 83.5% | 99.8% | 99.8% | 93.1% | 11.20 | |
| 10 | 89.1% | 83.6% | 99.7% | 99.8% | 93.1% | 11.25 | âœ… Ckpt |
| 11 | **89.5%** | **83.7%** | 99.7% | 99.9% | **93.2%** | 11.21 | âœ¨ Best |

#### Ablation (MHC-only) å®Œæ•´æ•°æ®

| Epoch | R@10 HV | R@10 HJ | R@10 LV | R@10 LJ | R@10 Avg | Val Loss | å¤‡æ³¨ |
|-------|---------|---------|---------|---------|----------|----------|------|
| 1 | 86.7% | 82.6% | 99.7% | 99.8% | 92.2% | 10.25 | ğŸ èµ·ç‚¹ |
| 2 | 87.1% | 82.4% | 99.6% | 99.8% | 92.2% | 10.70 | |
| 3 | 87.9% | 82.3% | 99.7% | 99.8% | 92.4% | 11.04 | |
| 4 | 87.8% | 82.7% | 99.6% | 99.8% | 92.5% | 11.22 | |
| 5 | 87.9% | 82.6% | 99.7% | 99.8% | 92.5% | 11.25 | |
| 6 | 88.1% | 82.8% | 99.7% | 99.8% | 92.6% | 11.34 | |
| 7 | 88.1% | 82.9% | 99.6% | 99.7% | 92.6% | 11.39 | |
| 8 | 88.6% | 82.9% | 99.6% | 99.8% | 92.7% | 11.33 | |
| 9 | 88.3% | 83.2% | 99.6% | 99.8% | 92.7% | 11.41 | |
| 10 | 88.7% | 82.7% | 99.7% | 99.8% | 92.7% | 11.51 | âœ… Ckpt |
| 11 | 88.3% | 82.8% | 99.7% | 99.8% | 92.7% | 11.43 | |
| 12 | **88.4%** | **83.0%** | 99.6% | 99.8% | **92.7%** | 11.44 | âœ¨ Best |
| 13 | 88.2% | 82.3% | 99.6% | 99.8% | 92.5% | 11.39 | è½»å¾®å›è½ |

### 11.4 Epoch 20 é¢„æµ‹

åŸºäº Epoch 1-13 çš„è¶‹åŠ¿ï¼Œä½¿ç”¨å¯¹æ•°è¡°å‡æ¨¡å‹æ‹Ÿåˆé¢„æµ‹ï¼š

```
é¢„æµ‹æ¨¡å‹: R@10(t) = R_max - Î± * exp(-t/Ï„)

å‚æ•°æ‹Ÿåˆ:
â€¢ Normal HV:  R_max = 90.2%, Î± = 4.0%, Ï„ = 2.5
â€¢ Ablation HV: R_max = 88.8%, Î± = 2.5%, Ï„ = 3.0
```

#### Epoch 14-20 é¢„æµ‹è¡¨

| Epoch | Normal HV (é¢„æµ‹) | Ablation HV (é¢„æµ‹) | Î” | ç½®ä¿¡åº¦ |
|-------|------------------|-------------------|---|--------|
| 14 | 89.7% | 88.4% | +1.3% | é«˜ |
| 15 | 89.8% | 88.5% | +1.3% | é«˜ |
| 16 | 89.9% | 88.6% | +1.3% | ä¸­é«˜ |
| 17 | 90.0% | 88.6% | +1.4% | ä¸­é«˜ |
| 18 | 90.0% | 88.7% | +1.3% | ä¸­ |
| 19 | 90.1% | 88.7% | +1.4% | ä¸­ |
| **20** | **90.1%** | **88.8%** | **+1.3%** | ä¸­ |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     R@10 HV é¢„æµ‹å¯è§†åŒ– (Epoch 1â†’20)                                 â”‚
â”‚                                                                                     â”‚
â”‚       â”‚                          å®æµ‹         â”‚        é¢„æµ‹                        â”‚
â”‚  91% â”€â”¤                                       â”‚                                    â”‚
â”‚       â”‚                                       â”‚                                    â”‚
â”‚  90% â”€â”¤                                       â”‚    â—â”â”â”â”â—â”â”â”â”â—â”â”â”â”â—â”â”â”â”â—            â”‚
â”‚       â”‚                              â—â”â”â”â”â”â”â—â”â”‚â”â”â—                 Normal           â”‚
â”‚  89% â”€â”¤                         â—â—â—â—          â”‚                                    â”‚
â”‚       â”‚                    â—â—â—â—               â”‚        â—‹â”â”â”â”â—‹â”â”â”â”â—‹â”â”â”â”â—‹â”â”â”â”â—‹        â”‚
â”‚  88% â”€â”¤               â—â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹â”â”â—‹â”â”â”â”â—‹â”â”â”‚â”â”â—‹                 Ablation          â”‚
â”‚       â”‚          â—â—â—‹â—‹â—‹                        â”‚                                    â”‚
â”‚  87% â”€â”¤     â—â—â—‹â—‹â—‹                             â”‚                                    â”‚
â”‚       â”‚ â—â—‹â—‹â—‹                                  â”‚                                    â”‚
â”‚  86% â”€â”¤â—‹                                      â”‚                                    â”‚
â”‚       â”‚                                       â”‚                                    â”‚
â”‚       â””â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”‚
â”‚           1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20
â”‚                                                                                     â”‚
â”‚  ç»“è®º: Epoch 20 æ—¶ Normal é¢„è®¡è¾¾ 90.1%, Ablation è¾¾ 88.8%, Î” ç»´æŒ +1.3%            â”‚
â”‚        æå‡ç©ºé—´ <1%, å»ºè®® Early Stop                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.5 Peptide è´¡çŒ®åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Peptide å¯¹ V/J é¢„æµ‹çš„è´¡çŒ®åˆ†æ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  HV (TRBV): Î” = +1.2%                                          â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚
â”‚  â”‚ Peptide æœ‰æ­£å‘è´¡çŒ®ï¼Œä½†å¹…åº¦æœ‰é™                               â”‚
â”‚                                                                 â”‚
â”‚  HJ (TRBJ): Î” = +0.9%                                          â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚
â”‚  â”‚ åŒä¸Š                                                         â”‚
â”‚                                                                 â”‚
â”‚  LV/LJ (TRAV/TRAJ): Î” â‰ˆ 0%                                     â”‚
â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚
â”‚  â”‚ å·²é¥±å’Œ (~100%)ï¼Œpeptide æ— æ˜æ˜¾é¢å¤–å¢ç›Š                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”Ÿç‰©å­¦è§£é‡Šï¼š
â€¢ MHC æ˜¯ V/J é€‰æ‹©çš„ä¸»å¯¼å› ç´ ï¼ˆå†³å®š 85-90% çš„åå¥½ï¼‰
â€¢ Peptide æä¾›è¾¹é™…ç»†åˆ†èƒ½åŠ›ï¼ˆ+0.5~1% é¢å¤–ç²¾åº¦ï¼‰
â€¢ ç¬¦åˆå…ç–«å­¦é¢„æœŸï¼šV/J ä¸»è¦å“åº” MHC é™åˆ¶ï¼Œpeptide ä¸»è¦å½±å“ CDR3
```

### 11.6 å…³é”®å‘ç°æ€»ç»“

| å‘ç° | ç»“è®º | è¡ŒåŠ¨å»ºè®® |
|------|------|----------|
| R@10 è¿œè¶…ç›®æ ‡ (93% vs 20%) | âœ… Stage 1 æ ¸å¿ƒç›®æ ‡è¾¾æˆ | å¯æå‰ç»“æŸè®­ç»ƒ |
| Peptide Î” â‰ˆ +0.5% | peptide è´¡çŒ®æœ‰é™ï¼Œç¬¦åˆé¢„æœŸ | ä¿ç•™ pMHC è¾“å…¥ä½†ä¸å¼ºæ±‚ |
| LV/LJ é¥±å’Œ (~100%) | è®­ç»ƒé›†è¦†ç›–å¥½ | æ— éœ€é¢å¤–ä¼˜åŒ– |
| BCE è¿‡æ‹Ÿåˆ | è¾…åŠ© loss æ•ˆæœæœ‰é™ | å¯ç§»é™¤æˆ–é™ä½ Î»_bce |
| å¿«é€Ÿæ”¶æ•› (Ï„â‰ˆ3) | æ¨¡å‹å®¹é‡è¶³å¤Ÿ | å¯è€ƒè™‘æ›´æ¿€è¿›çš„ Early Stop |

### 11.7 ä¸‹ä¸€æ­¥å»ºè®®

1. **çŸ­æœŸ**ï¼šç­‰å¾… Epoch 20-25 ç¡®è®¤ç¨³å®šå Early Stop
2. **ä¸­æœŸ**ï¼šå¯¼å‡º best checkpoint ä¾› Stage 2 ä½¿ç”¨
3. **å¯é€‰**ï¼š
   - ç§»é™¤ BCE loss é‡è®­ï¼ˆéªŒè¯æ˜¯å¦æ›´ç®€æ´ï¼‰
   - å°è¯•æ›´å° LoRA rankï¼ˆæ•ˆç‡ä¼˜åŒ–ï¼‰
